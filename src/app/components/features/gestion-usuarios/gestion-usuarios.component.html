<!--Tabla de usuarios-->
<div *ngIf="rol === 'administrador'" class="container mt-3">
  <!-- Campo de búsqueda -->
  <div class="d-flex">
    <div class="barra-busqueda mb-3">
      <label for="busqueda" class="form-label"> </label>
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          placeholder="Búsqueda de usuario por nombre, apellido y cédula"
          id="busqueda"
          [(ngModel)]="filtroBusqueda"
          (input)="realizarBusqueda()"
        />
        <span class="input-group-text">
          <i class="fas fa-search"></i>
        </span>
      </div>
    </div>
    <nav class="mb-5 navbar">
      <div class="container">
        <div class="d-flex align-items-end pt-4">
          <form class="d-flex" role="search">
            <div *ngIf="rol === 'administrador'">
              <button
                style="
                  background: #136137;
                  text-decoration: none !important;
                  font-weight: 500;
                  color: #fff;
                  text-transform: uppercase;
                  font-size: 14px;
                  padding: 10px 24px;
                  display: inline-block;
                  border-radius: 50px;
                "
                type="button"
                class="btn btn-success ml-3"
                [routerLink]="['/agregarEmpleado']"
              >
                Agregar Empleado
              </button>
            </div>
          </form>
        </div>
      </div>
    </nav>
  </div>
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-striped table-bordered">
        <thead class="thead-dark">
          <tr>
            <th scope="col">#</th>
            <th scope="col">Cedula</th>
            <th scope="col">Nombre</th>
            <th scope="col">Apellido</th>
            <th scope="col">Correo</th>
            <th scope="col">Rol</th>
            <th scope="col">Estado</th>
            <th scope="col">Accion</th>
          </tr>
        </thead>
        <tbody>
          <ng-container
            *ngFor="
              let usuario of usuarios.slice(
                (paginaActual - 1) * usuariosPorPagina,
                paginaActual * usuariosPorPagina
              );
              let i = index
            "
          >
            <tr>
              <th scope="row">
                {{ (paginaActual - 1) * usuariosPorPagina + i + 1 }}
              </th>

              <td>
                {{ usuario.cedula }}
              </td>

              <td>
                <ng-container *ngIf="estaEditando(usuario)">
                  <input [(ngModel)]="usuario.nombre" class="form-control" />
                  <span class="text-muted"> </span>
                  <ng-container
                    *ngIf="
                      validarNombre(usuario.nombre).nombreValido &&
                      !validarNombre(usuario.nombre).caracterEspecial
                    "
                  >
                    <span class="text-success iconos">✓</span>
                    <span class="text-success">Nombre válido</span>
                  </ng-container>
                  <ng-container
                    *ngIf="!validarNombre(usuario.nombre).nombreValido"
                  >
                    <span class="text-danger iconos">✕</span>
                    <span class="text-danger">{{
                      validarNombre(usuario.nombre).mensaje
                    }}</span>
                  </ng-container>
                  <ng-container
                    *ngIf="validarNombre(usuario.nombre).contieneNumeros"
                  >
                    <span class="text-danger"></span>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!estaEditando(usuario)">
                  {{ usuario.nombre }}
                </ng-container>
              </td>

              <td>
                <ng-container *ngIf="estaEditando(usuario)">
                  <input [(ngModel)]="usuario.apellido" class="form-control" />
                  <span class="text-muted"> </span>
                  <ng-container
                    *ngIf="
                      validarApellido(usuario.apellido).apellidoValido &&
                      !validarApellido(usuario.apellido).caracterEspecial
                    "
                  >
                    <span class="text-success iconos">✓</span>
                    <span class="text-success">Apellido válido</span>
                  </ng-container>
                  <ng-container
                    *ngIf="!validarApellido(usuario.apellido).apellidoValido"
                  >
                    <span class="text-danger iconos">✕</span>
                    <span class="text-danger">{{
                      validarApellido(usuario.apellido).mensaje
                    }}</span>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!estaEditando(usuario)">
                  {{ usuario.apellido }}
                </ng-container>
              </td>

              <td>
                <ng-container *ngIf="estaEditando(usuario)">
                  <input [(ngModel)]="usuario.correo" class="form-control" />
                  <span class="text-muted"> </span>
                  <ng-container *ngIf="validarCorreo(usuario.correo)">
                    <span class="text-success iconos">✓</span>
                    <span class="text-success">Correo válido</span>
                  </ng-container>
                  <ng-container *ngIf="!validarCorreo(usuario.correo)">
                    <span class="text-danger iconos">✕</span>
                    <span class="text-danger">Correo no válido</span>
                  </ng-container>
                </ng-container>
                <ng-container *ngIf="!estaEditando(usuario)">
                  {{ usuario.correo }}
                </ng-container>
              </td>

              <td>
                <ng-container
                  *ngIf="
                    estaEditando(usuario) && esMyUsuario() != true;
                    else usuarioRol
                  "
                >
                  <app-role-dropdown
                    [selectedRole]="usuario.rol"
                    (roleSelected)="updateUserRole($event, usuario)"
                  ></app-role-dropdown>
                </ng-container>
                <ng-template #usuarioRol>
                  {{ usuario.rol }}
                </ng-template>
              </td>

              <td>
                <ng-container
                  *ngIf="
                    estaEditando(usuario) && esMyUsuario() != true;
                    else usuarioEstado
                  "
                >
                  <app-estado-dropdown
                    [estadoSeleccionado]="estadoSeleccionado"
                    (estadoSeleccionadoOutput)="
                      updateUserEstado($event, usuario)
                    "
                  ></app-estado-dropdown>
                </ng-container>
                <ng-template #usuarioEstado>
                  {{ usuario.estaInactivo ? "inactivo" : "activo" }}
                </ng-template>
              </td>

              <td>
                <button
                  type="button"
                  class="btn btn-outline-success ml-3 mr-3"
                  *ngIf="!estaEditando(usuario)"
                  (click)="editarUsuario(usuario)"
                >
                  Editar
                </button>
                <div class="d-flex flex-row">
                  <button
                    type="button"
                    class="btn btn-outline-success ml-3"
                    *ngIf="estaEditando(usuario)"
                    (click)="confirmarGuardarCambios(usuario)"
                    [disabled]="
                      !validarNombre(usuario.nombre).nombreValido ||
                      validarNombre(usuario.nombre).caracterEspecial ||
                      validarNombre(usuario.nombre).contieneNumeros ||
                      !validarApellido(usuario.apellido).apellidoValido ||
                      validarApellido(usuario.apellido).caracterEspecial ||
                      validarApellido(usuario.apellido).contieneNumeros ||
                      !validarCorreo(usuario.correo)
                    "
                  >
                    Guardar
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger ml-2 mr-3"
                    *ngIf="estaEditando(usuario)"
                    (click)="cancelarEdicion(usuario)"
                  >
                    Cancelar
                  </button>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-center">
      <ul class="pagination">
        <li
          class="page-item"
          *ngFor="let pagina of calcularPaginas(); let i = index"
        >
          <a class="page-link cursor" (click)="cambiarPagina(i + 1)">{{
            i + 1
          }}</a>
        </li>
      </ul>
    </div>
  </div>
</div>
